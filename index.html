<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ©Ÿèƒ½ãƒ»ãã‚ã°ã‚“èª­ã¿ä¸Šã’ç®—ã‚¢ãƒ—ãƒª</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§®</text></svg>">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5883631303166555"
     crossorigin="anonymous"></script>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        .settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            text-align: left;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }
        .setting-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff;
        }
        .checkbox-group {
            grid-column: span 2;
            display: flex;
            align-items: center;
            margin-top: 5px;
            padding: 5px 0;
            border-top: 1px solid #eee;
        }
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .btn-answer {
            background-color: #27ae60;
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            margin-top: 10px;
        }
        .btn-answer:hover {
            background-color: #219150;
        }
        
        /* å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #problem-container {
            margin: 20px 0;
            border-top: 2px solid #eee;
            border-bottom: 2px solid #eee;
            max-height: 300px;
            overflow-y: auto;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #problem-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }
        
        #problem-list li {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.4em;
            letter-spacing: 2px;
            transition: color 0.3s;
        }

        /* ãƒã‚¤ãƒŠã‚¹ã®æ–‡å­—è‰²æŒ‡å®š */
        li.negative-val {
            color: #e74c3c;
        }

        /* æš—ç®—ãƒ¢ãƒ¼ãƒ‰ï¼ˆç­”ãˆè¡¨ç¤ºå‰ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        /* !important ã‚’ä½¿ç”¨ã—ã¦å¼·åˆ¶çš„ã«é€æ˜ã«ã—ã¾ã™ */
        .blind-mode li {
            color: transparent !important;
            text-shadow: 0 0 15px rgba(0,0,0,0.15); /* ã†ã£ã™ã‚‰å½±ã ã‘æ®‹ã™ */
            user-select: none;
        }

        #result-area {
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: bold;
            color: #c0392b;
            display: none;
            padding: 10px;
            border: 2px solid #c0392b;
            border-radius: 8px;
            background-color: #fff0f0;
        }
        
        .status {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
            font-weight: bold;
            height: 1.2em;
        }

        .speed-value {
            font-size: 0.8em;
            float: right;
            color: #3498db;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ§® èª­ã¿ä¸Šã’ç®—ãƒã‚¹ã‚¿ãƒ¼</h1>
        
        <div class="settings">
            <div class="setting-group">
                <label for="min-digits">æœ€å°æ¡æ•°</label>
                <select id="min-digits" onchange="saveSettings()"></select>
            </div>
            <div class="setting-group">
                <label for="max-digits">æœ€å¤§æ¡æ•°</label>
                <select id="max-digits" onchange="saveSettings()"></select>
            </div>
            <div class="setting-group">
                <label for="count">å£æ•° (å›æ•°)</label>
                <select id="count" onchange="saveSettings()">
                    <option value="3">3å£</option>
                    <option value="5">5å£</option>
                    <option value="7">7å£</option>
                    <option value="10">10å£</option>
                    <option value="15">15å£</option>
                    <option value="20">20å£</option>
                </select>
            </div>
            <div class="setting-group">
                <label>èª­ã¿ä¸Šã’é€Ÿåº¦ <span id="speed-display" class="speed-value">1.0å€</span></label>
                <input type="range" id="speed" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateSpeedDisplay(); saveSettings()">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="allow-subtraction" onchange="saveSettings()">
                <label for="allow-subtraction">å¼•ãç®—ã‚’å«ã‚ã‚‹ (åŠ æ¸›ç®—)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="blind-mode" onchange="saveSettings()">
                <label for="blind-mode">æ•°å­—ã‚’éš ã™ (éŸ³å£°ã®ã¿ã§ç·´ç¿’)</label>
            </div>
        </div>

        <button class="btn" id="start-btn" onclick="startProblem()">å•é¡Œä½œæˆ & èª­ã¿ä¸Šã’é–‹å§‹</button>
        
        <div class="status" id="status-text"></div>

        <button class="btn btn-answer" id="show-answer-btn" onclick="showAnswer()">ç­”ãˆã‚’è¡¨ç¤º</button>

        <div id="result-area"></div>

        <div id="problem-container">
            <ul id="problem-list"></ul>
        </div>
    </div>

    <script>
        // è¨­å®šå€¤ã®ã‚­ãƒ¼
        const STORAGE_KEY = 'soroban_app_settings_v1';

        // ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        window.onload = function() {
            initSelectOptions();
            loadSettings(); // è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
        };

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ç”Ÿæˆ
        function initSelectOptions() {
            const minSel = document.getElementById('min-digits');
            const maxSel = document.getElementById('max-digits');
            
            for (let i = 1; i <= 16; i++) {
                let optMin = document.createElement('option');
                optMin.value = i;
                optMin.text = i + "æ¡";
                minSel.appendChild(optMin);

                let optMax = document.createElement('option');
                optMax.value = i;
                optMax.text = i + "æ¡";
                maxSel.appendChild(optMax);
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ãŸå ´åˆç”¨ï¼‰
            minSel.value = 2;
            maxSel.value = 3;
            document.getElementById('count').value = 5;
        }

        // è¨­å®šã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
        function saveSettings() {
            const settings = {
                minDigits: document.getElementById('min-digits').value,
                maxDigits: document.getElementById('max-digits').value,
                count: document.getElementById('count').value,
                speed: document.getElementById('speed').value,
                allowSubtraction: document.getElementById('allow-subtraction').checked,
                blindMode: document.getElementById('blind-mode').checked
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        }

        // è¨­å®šã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        function loadSettings() {
            const json = localStorage.getItem(STORAGE_KEY);
            if (json) {
                const settings = JSON.parse(json);
                
                if (settings.minDigits) document.getElementById('min-digits').value = settings.minDigits;
                if (settings.maxDigits) document.getElementById('max-digits').value = settings.maxDigits;
                if (settings.count) document.getElementById('count').value = settings.count;
                if (settings.speed) {
                    document.getElementById('speed').value = settings.speed;
                    updateSpeedDisplay();
                }
                if (settings.allowSubtraction !== undefined) document.getElementById('allow-subtraction').checked = settings.allowSubtraction;
                if (settings.blindMode !== undefined) document.getElementById('blind-mode').checked = settings.blindMode;
            }
        }

        function updateSpeedDisplay() {
            const val = document.getElementById('speed').value;
            document.getElementById('speed-display').innerText = parseFloat(val).toFixed(1) + "å€";
        }

        let problemNumbers = [];
        let totalAnswer = 0;
        let isReading = false;

        function getJapaneseVoice() {
            const voices = window.speechSynthesis.getVoices();
            return voices.find(v => v.name === 'Google æ—¥æœ¬èª') || 
                   voices.find(v => v.lang === 'ja-JP') || null;
        }
        window.speechSynthesis.onvoiceschanged = getJapaneseVoice;

        function generateRandomNumber(digits) {
            const min = Math.pow(10, digits - 1);
            const max = Math.pow(10, digits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function startProblem() {
            if (isReading) return;

            // è¨­å®šã®ä¿å­˜ï¼ˆå¿µã®ç‚ºã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ã‚‚ä¿å­˜ï¼‰
            saveSettings();

            let minDigits = parseInt(document.getElementById('min-digits').value);
            let maxDigits = parseInt(document.getElementById('max-digits').value);
            const count = parseInt(document.getElementById('count').value);
            const allowSubtraction = document.getElementById('allow-subtraction').checked;
            const isBlindMode = document.getElementById('blind-mode').checked;

            if (minDigits > maxDigits) {
                [minDigits, maxDigits] = [maxDigits, minDigits];
                document.getElementById('min-digits').value = minDigits;
                document.getElementById('max-digits').value = maxDigits;
            }
            
            problemNumbers = [];
            totalAnswer = 0;
            const listElement = document.getElementById('problem-list');
            listElement.innerHTML = '';
            
            // ã‚¯ãƒ©ã‚¹ã®ä»˜ä¸
            if (isBlindMode) {
                listElement.className = 'blind-mode';
            } else {
                listElement.className = '';
            }

            // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('show-answer-btn').style.display = 'none';
            document.getElementById('status-text').innerText = 'èª­ã¿ä¸Šã’ä¸­...';

            for (let i = 0; i < count; i++) {
                const currentDigits = Math.floor(Math.random() * (maxDigits - minDigits + 1)) + minDigits;
                let num = generateRandomNumber(currentDigits);
                
                if (allowSubtraction && i > 0 && Math.random() < 0.4) {
                    num = -num;
                }
                
                if (totalAnswer + num < 0) {
                    num = Math.abs(num);
                }

                problemNumbers.push(num);
                totalAnswer += num;

                const li = document.createElement('li');
                if (num < 0) {
                     li.innerText = "â–² " + Math.abs(num).toLocaleString();
                     li.classList.add('negative-val');
                } else {
                     li.innerText = num.toLocaleString();
                }
                listElement.appendChild(li);
            }

            readAloud();
        }

        function readAloud() {
            isReading = true;
            document.getElementById('start-btn').disabled = true;
            const speedRate = parseFloat(document.getElementById('speed').value);

            const u = new SpeechSynthesisUtterance();
            u.lang = 'ja-JP';
            u.rate = speedRate; 
            
            const voice = getJapaneseVoice();
            if (voice) u.voice = voice;

            let text = "é¡˜ã„ã¾ã—ã¦ã¯ã€";
            let currentSign = 1;

            problemNumbers.forEach((num, index) => {
                const absNum = Math.abs(num);
                
                if (index === 0) {
                    text += `${absNum}å††ãªã‚Šã€`;
                } else {
                    if (num < 0) {
                        if (currentSign === 1) text += `å¼•ã„ã¦ã¯ã€`;
                        else text += ``; 
                        
                        text += `${absNum}å††ãªã‚Šã€`;
                        currentSign = -1;
                    } else {
                        if (currentSign === -1) text += `åŠ ãˆã¦ã€`;
                        text += `${absNum}å††ãªã‚Šã€`;
                        currentSign = 1;
                    }
                }
            });

            text += "ã§ã¯ã€‚";
            u.text = text;

            u.onend = function(event) {
                isReading = false;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('status-text').innerText = 'èª­ã¿ä¸Šã’çµ‚äº†ã€‚è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚';
                // èª­ã¿ä¸Šã’çµ‚äº†å¾Œã«ã€Œç­”ãˆã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('show-answer-btn').style.display = 'inline-block';
            };

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }

        function showAnswer() {
            // ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰è§£é™¤
            document.getElementById('problem-list').classList.remove('blind-mode');

            const resultArea = document.getElementById('result-area');
            resultArea.innerText = "ç­”ãˆ: " + totalAnswer.toLocaleString() + " å††";
            resultArea.style.display = 'block';
            
            document.getElementById('status-text').innerText = 'æ­£è§£ç¢ºèª';

            const u = new SpeechSynthesisUtterance();
            u.lang = 'ja-JP';
            u.rate = parseFloat(document.getElementById('speed').value);
            const voice = getJapaneseVoice();
            if (voice) u.voice = voice;
            
            u.text = "ã”ã‚ã„ã•ã‚“ã§ã™ã€‚ç­”ãˆã¯ã€" + totalAnswer + "å††ã§ã™ã€‚";
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>